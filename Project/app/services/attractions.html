<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">

    <title>Attractions</title>

    <link rel="stylesheet" href="">
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- Bootstrap libraries -->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Latest compiled and minified CSS -->

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <!-- Latest compiled and minified JavaScript -->
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>

<!-- Bootstrap libraries -->
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">


<!-- Latest compiled and minified JavaScript -->
<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->


<body>
    <div id="main-container" class="container">
        <h1 class="display-4">Book Search</h1>
        Latitude <input name="lat" type="text" id="lat">
        Longitude <input name="lon" type="text" id="lon">
        Radius <input name="radius" type="text" id="radius" value="1000">
        Type <input name="type" type="text" id="type" value="cafe">
        <button type="button" class="btn btn-primary" onclick="getLocation()">Current Location</button>
        <br>
        <button type="button" class="btn btn-primary" onclick='search()'>Submit</button>
        <br>
        <br>

        <h1> Results </h1>
        <div class="row row-cols-3 row-cols-md-3 g-4 justify-content-center" id="searchOutput">

        </div>
        <div id="display_next_page_button">

        </div>
        <!-- Modal -->
        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="modal-body">

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>

                    </div>
                </div>
            </div>
        </div>
        <script>
            // Helper function to display error message
            var counter = 0
            function showError(message) {
                // Hide the table and button in the event of error
                $('#booksTable').hide();
                $('#addBookBtn').hide();

                // Display an error under the main container
                $('#main-container')
                    .append("<label>" + message + "</label>");
            }
            function showPosition(position) {
                $("#lat").val(position.coords.latitude);
                $("#lon").val(position.coords.longitude);
            }

            async function search(page_token) {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(showPosition);
                }

                let lat = $("#lat").val();
                let lon = $("#lon").val();
                let radius = $("#radius").val();
                let type = $("#type").val();
                let API_KEY = 'AIzaSyAw3Q7eJyqIazB2ucevU3NhnVmsqs5Z3bQ';

                var serviceURL = `https://cors-anywhere.herokuapp.com/https://maps.googleapis.com/maps/api/place/nearbysearch/json?location=${lat},${lon}&radius=${radius}&type=${type}&key=${API_KEY}`;

                if (page_token != undefined) {
                    
                    console.log(page_token);
                    serviceURL = `https://cors-anywhere.herokuapp.com/https://maps.googleapis.com/maps/api/place/nearbysearch/json?pagetoken=${page_token}&key=${API_KEY}`
                }

                try {
                    const response =
                        await fetch(
                            serviceURL, { method: 'GET' }
                        );

                    const result = await response.json();
                    if (response.status === 200) {
                        // success case

                        console.log(result.results)
                        $("#searchOutput").empty()
                        for (let location of result.results) {

                            if ("photos" in location) {
                                var photo = location.photos[0].photo_reference
                            }
                            else {
                                var photo = ""
                            }
                            if (location.business_status == "CLOSED_TEMPORARILY") {
                                var status = "Closed Now"
                            }
                            else {
                                if ("opening_hours" in location) {
                                    if (location.opening_hours.open_now) {
                                        var status = "Open Now";
                                    }
                                    else {
                                        var status = "Closed Now"
                                    }
                                } else {
                                    var status = "Closed Now"
                                }
                            }

                            if (location.rating <= 1) {
                                var emoji = "&#128532"
                            }
                            else if (location.rating <= 2) {
                                var emoji = "&#128533"
                            }
                            else if (location.rating <= 3) {
                                var emoji = "&#128528"
                            }
                            else if (location.rating <= 4) {
                                var emoji = "&#128516"
                            }
                            else if (location.rating <= 5) {
                                var emoji = "&#128522"
                            }
                            else if (location.rating == undefined) {
                                var emoji = "&#129300"
                            }
                            $("#searchOutput").append(
                                `<div class="col">
                                <div class="card h-100" style="width: 350px">
                                    <img src="https://maps.googleapis.com/maps/api/place/photo?maxwidth=350&maxheight=350&photoreference=${photo}&key=${API_KEY}
                                    " class="card-img-top">
                                    <div class="card-body">
                                        <h5 class="card-title">${location.name}</h5>
                                        <h6 class="card-subtitle mb-2 text-muted">${status}</h6>
                                        <ul class="list-group list-group-flush">
                                            <li class="list-group-item"><b>Address:</b> <p>${location.vicinity}</p></li>
                                            <li class="list-group-item"><b>Price Level:</b> ${location.price_level} &#128184</li>
                                            <li class="list-group-item"><b>Rating:</b> ${location.rating} ${emoji}</li>
                                        </ul>
                                        <br>
                                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal" onclick="getDirections('${location.place_id}','${lat}/${lon}')">Directions</button>
                                    </div>
                                </div>
                            </div>`

                            )

                        }
                        if ("next_page_token" in result) {
                            var next_page_token = result.next_page_token;
                            counter++
                            if (counter != 3) {
                                $("#display_next_page_button").html(
                                    `<button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="search('${next_page_token}')">Next Page</button>
`                               )
                            }
                            else {
                                $("#display_next_page_button").attr('disabled', true);
                            }

                        }

                    } else if (response.status == 404) {
                        // No books
                        showError(result.message);
                    } else {
                        // unexpected outcome, throw the error
                        throw response.status;
                    }
                } catch (error) {
                    // Errors when calling the service; such as network error, 
                    // service offline, etc
                    $("#list").empty()
                    showError
                        ('There is a problem retrieving books data, please try again later.<br />' + error);
                } // error

            }
            function getDirections(place_id, current_coor) {
                let API_KEY = 'AIzaSyAw3Q7eJyqIazB2ucevU3NhnVmsqs5Z3bQ';
                $("#modal-body").html(
                    `<iframe width="450" height="400" frameborder="0" style="border:0"
                            src="https://www.google.com/maps/embed/v1/directions?key=${API_KEY}&origin=${current_coor}&mode=transit&destination=place_id:${place_id}"
                            allowfullscreen>
                    </iframe>`

                )

            }
        </script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.1/dist/umd/popper.min.js"
            integrity="sha384-SR1sx49pcuLnqZUnnPwx6FCym0wLsk5JZuNx2bPPENzswTNFaQU1RDvt3wT4gWFG"
            crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.min.js"
            integrity="sha384-j0CNLUeiqtyaRmlzUHCPZ+Gy5fQu0dQ6eZ/xAww941Ai1SxSY+0EQqNXNE6DZiVc"
            crossorigin="anonymous"></script>
</body>

</html>